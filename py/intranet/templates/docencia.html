{% extends "base.html" %}
{% set active_sec = 'Test' %}
{% block head %}

    {% if not auth %}
    <meta http-equiv="refresh" content="0; URL={{login_url}}">
    {% endif %}

{% endblock %}
{% block content %}

    <h1>Asignación de docencia para {{aa.givenName}} {{aa.sn}}</h1>

    <div class="text-danger" id="errors"></div>
    <form onsubmit="postUI(this); return false;">
        <input id="userid" type="hidden"></input>
        <input id="areaid" type="hidden"></input>
        <div class="form-row">
            <div class="form-group col-md-6">
                <label for="chooserid">Profesor</label> 
                <select id="chooserid" class="form-control"></select>
            </div>
            <div class="form-check bottom-column">
                <input class="form-check-input" id="head" name="sexenio_vivo" type="checkbox"></input>
                <label class="form-check-label" for="head">Jefe de área</label>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-12">
                <label for="docencia">Asignaturas del área</label> 
                <select id="docencia" class="form-control" style="height:200px" multiple></select>
            </div>
        </div>
        <button id="actualizar" class="btn btn-primary" type="submit" disabled>
            Actualizar
            <span id="pending" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        </button>
    </form>

    <script>
        const docencia = document.getElementById('docencia');

        function pending(v) {
            const img = document.querySelector("#pending");
            img.style.display = (v ? "block": "none");
            const b = document.querySelector('#actualizar');
            b.disabled = false;
        }

        function getProfesor(userid) {
            var req = new XMLHttpRequest();
            req.onload  = function() {
                if (req.status >= 300) {
                    showError(req.responseText);
                    return;
                }
                var profe = JSON.parse(req.responseText);
                getProfesoresArea(profe);
                getAsignaturasArea(profe);
            };
            req.open('GET', '/v2/profesores.expandidos/por_userid/' + userid, true);
            req.send();
        }

        function getProfesoresArea(profe) {
            var req = new XMLHttpRequest();
            req.onload  = function() {
                if (req.status >= 300) {
                    showError(req.responseText);
                    return;
                }
                var resp = JSON.parse(req.responseText);
                for (var i = 0; i < resp.length; ++i) {
                    const p = resp[i];
                    uid.options.add(new Option(p.sn + ', ' + p.givenName, p.userid));
                }
                uid.options[0].selected = true;
            };
            req.open('GET', '/v2/profesores.expandidos/por_areaid/' + areaid, true);
            req.send();
        }

        function getAsignaturasArea(profe) {
            pending(true);
            var req = new XMLHttpRequest();
            req.onload  = function() {
                var resp = JSON.parse(req.responseText);
                docencia.disabled = true;
                for (var i = 0; i < resp.length; ++i) {
                    const p = resp[i];
                    docencia.options.add(new Option(p.asignatura + ' (' + p.titulo + ')', p.asigid));
                }
                sortSelect(docencia);
                // getAsignaturasProfe(profe);
                pending(false);
            };
            req.open('GET', '/v2/docencia.por_area/por_areaid/' + profe.areaid, true);
            req.send();
        }

        function sortSelect(sel) {
            var arr = new Array();
            for (var i = 0; i < sel.options.length; ++ i)
                arr.push([sel.options[i].text, sel.options[i].value]);
            arr.sort();
            while (sel.options.length > 0) {
                sel.options[0] = null;
            }
            arr.forEach(function(e) {
                sel.options.add(new Option(e[0], e[1]));
            });
        }

        getProfesor('{{ aa.uid }}');
</script>
{% endblock %}
